// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

enum Role {
  USER
  ADMIN
  MOD
}

enum PaymentStatus {
  approved
  pending
  rejected
}

enum NivelIngles {
  inicial
  basico
  intermedio
  avanzado
}

enum Status {
  scheduled
  pending //cancelled
  completed
  cancelled
}

enum ClassType {
  individual
  grupal
}

enum HostType {
  anfitrion
  invitado
}

enum ActivityStatus {
  uploaded
  pending
}

enum Level {
  easy
  medium
  hard
}

enum Type {
  exam
  audio
  video
  reading
}

enum classRole {
  anfitrion
  participante
}

enum Newsletter {
  si
  no
}

// Definimos los estados posibles
enum TicketStatus {
  OPEN // Recién creado
  IN_PROGRESS // Ya lo estás revisando
  RESOLVED // Solucionado
  CLOSED // Cerrado definitivamente
}

enum TicketPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum SenderRole {
  USER
  ADMIN
  SUPPORT_BOT // Por si a futuro pones una IA a responder sola ;)
}

// Este es un "Embed" (sub-documento), no una tabla aparte. 
// Ideal para MongoDB.
type TicketMessage {
  content   String
  role      SenderRole // Quién escribió: ¿El usuario o tú?
  createdAt DateTime   @default(now())
}

// * DATABASE MODELS * //

model User {
  id                 String               @id @default(auto()) @map("_id") @db.ObjectId
  email              String               @unique
  name               String
  image              String?
  localidad          String?              @default("-")
  telefono           Int?                 @default(0)
  nivel              NivelIngles          @default(inicial)
  status             Boolean              @default(false)
  newsletter         Newsletter           @default(no)
  totalClasses       Int                  @default(0)
  UserActivity       UserActivity[]
  PaymentMercadoPago PaymentMercadoPago[]
  SupportTicket      SupportTicket[]
  googleRefreshToken String?
  createdAt          DateTime             @default(now())
  updatedAt          DateTime             @updatedAt
}

model VirtualClass {
  id                  String         @id @default(auto()) @map("_id") @db.ObjectId // classId
  googleEventId       String?        @unique // allow me to modify this event
  bookedById          String         @db.ObjectId // same id than model User: id
  accessCode          String?
  startTime           DateTime
  endTime             DateTime
  hostType            HostType       @default(anfitrion)
  currentParticipants Int            @default(1)
  maxParticipants     Int // studentsCount
  classType           ClassType
  classPrice          Int
  htmlLink            String?
  status              Status         @default(pending) // scheduled, cancelled, completed
  summary             String?
  description         String?
  learningFocus       String?
  preferenceId        String?        @db.String //@unique // Mercado Pago preference ID
  activityStatus      ActivityStatus @default(pending)
  participantsIds     String[]       @default([])
  UserActivity        UserActivity[]
  createdAt           DateTime       @default(now())
  updatedAt           DateTime       @updatedAt
}

model Task {
  id            String         @id @default(auto()) @map("_id") @db.ObjectId
  title         String
  content       String // Markdown AI
  solvedContent String // Markdown answer AI
  description   String // Short description about the task
  type          Type
  difficulty    Level          @default(medium)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  UserActivity  UserActivity[]
}

model UserActivity {
  id        String        @id @default(auto()) @map("_id") @db.ObjectId
  userId    String        @db.ObjectId
  taskId    String?       @db.ObjectId
  classId   String        @db.ObjectId
  rol       classRole
  completed Boolean?      @default(false)
  user      User?         @relation(fields: [userId], references: [id])
  task      Task?         @relation(fields: [taskId], references: [id])
  class     VirtualClass? @relation(fields: [classId], references: [id])
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
}

model PaymentMercadoPago {
  id              String        @id @default(auto()) @map("_id") @db.ObjectId
  userId          String        @db.ObjectId
  preferenceId    String        @unique
  price           Int
  type            ClassType
  maxParticipants Int
  status          PaymentStatus @default(pending)
  user            User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
}

model VisitorInquiry {
  id            String    @id @default(auto()) @map("_id") @db.ObjectId
  medioContacto String
  mensaje       String
  response      String? // admin response
  respondedAt   DateTime? // null until responded
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

model SupportTicket {
  id           String          @id @default(auto()) @map("_id") @db.ObjectId
  userId       String          @db.ObjectId
  ticketNumber String          @unique
  description  String // "Me sale error 500 cuando hago click..."
  category     String // "BUG", "PAGOS", "CUENTA"
  status       TicketStatus    @default(OPEN)
  priority     TicketPriority  @default(MEDIUM)
  messages     TicketMessage[]
  user         User            @relation(fields: [userId], references: [id])
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt
}
